# 微信公众号文章爬虫系统 - 开发日志

## 项目开发周期
2025-03-27 至今

## 开发日志

### 阶段一：项目初始化与基础架构搭建
#### 2025-03-15
1. 项目初始化
   - 创建 Spring Boot 项目
   - 配置 Maven 依赖
   - 设置基本项目结构

2. 数据库设计
   - 创建 MySQL 数据库
   - 设计文章表结构
   - 配置 MyBatis

3. 前端项目搭建
   - 创建 Vue.js 项目
   - 集成 Element Plus
   - 配置开发环境

### 阶段二：核心功能开发
#### 2025-03-20
1. 爬虫功能实现
   - 集成 WebMagic 框架
   - 实现文章内容抓取
   - 开发图片下载功能

2. 搜索功能开发
   - 集成 Lucene 搜索引擎
   - 实现文章索引创建
   - 开发搜索接口

3. 前端界面开发
   - 实现文章列表展示
   - 开发搜索组件
   - 添加文章管理功能

### 阶段三：系统优化与问题修复
#### 2025-03-27
1. 性能优化
   - 优化数据库查询
   - 实现缓存机制
   - 改进搜索性能

2. 问题修复
   - 解决 CORS 跨域问题
   - 修复日期解析错误
   - 完善错误处理

## 技术难点解决方案

### 1. 爬虫实现
#### 问题描述
- 需要准确提取微信公众号文章内容
- 处理文章发布时间格式多样性
- 管理图片下载和存储

#### 解决方案
1. 使用 WebMagic 框架
   - 自定义页面处理器
   - 实现智能解析规则
   - 处理异常情况

2. 日期解析优化
   - 使用正则表达式匹配多种格式
   - 统一转换为标准格式
   - 添加格式验证

3. 图片处理
   - 异步下载图片
   - 本地化存储
   - 建立索引关联

### 2. 搜索功能
#### 问题描述
- 需要支持全文搜索
- 要求搜索结果准确性
- 性能需要优化

#### 解决方案
1. Lucene 索引设计
   - 合理设计索引字段
   - 优化索引策略
   - 实现实时更新

2. 搜索优化
   - 实现多字段搜索
   - 添加结果评分
   - 支持高级筛选

### 3. 前后端交互
#### 问题描述
- 跨域访问限制
- 数据传输格式
- 异步操作处理

#### 解决方案
1. CORS 配置
   - 统一配置跨域策略
   - 规范请求头设置
   - 处理预检请求

2. 数据交互
   - 统一响应格式
   - 规范错误处理
   - 实现数据验证

## 性能优化记录

### 1. 数据库优化
1. 索引优化
   - 添加合适的索引
   - 优化查询语句
   - 定期维护索引

2. 连接池配置
   - 调整连接池大小
   - 优化超时设置
   - 监控连接状态

### 2. 搜索优化
1. 索引优化
   - 定期重建索引
   - 优化索引结构
   - 实现增量索引

2. 查询优化
   - 实现缓存机制
   - 优化查询逻辑
   - 提高响应速度

### 3. 前端优化
1. 页面性能
   - 组件懒加载
   - 资源压缩
   - 缓存策略

2. 用户体验
   - 添加加载提示
   - 优化交互流程
   - 提升响应速度

## 待优化项目

### 功能优化
1. 爬虫功能
   - [ ] 支持批量爬取
   - [ ] 添加定时任务
   - [ ] 优化错误重试

2. 搜索功能
   - [ ] 添加搜索建议
   - [ ] 支持高级过滤
   - [ ] 优化排序算法

3. 用户界面
   - [ ] 优化移动端适配
   - [ ] 添加数据可视化
   - [ ] 完善操作反馈

### 性能优化
1. 后端优化
   - [ ] 添加缓存层
   - [ ] 优化数据库查询
   - [ ] 实现分布式部署

2. 前端优化
   - [ ] 实现虚拟滚动
   - [ ] 优化资源加载
   - [ ] 改进状态管理

## 项目维护注意事项

### 1. 代码维护
- 遵循代码规范
- 及时更新文档
- 定期代码审查

### 2. 运行维护
- 定期备份数据
- 监控系统状态
- 及时处理异常

### 3. 性能维护
- 定期优化数据库
- 监控系统性能
- 及时处理性能问题

## 联系方式
- 后端开发：[chen]
- 前端开发：[chen]
- 技术支持：[2021011100@bistu.edu.cn]

## 4月21日更新 - 爬虫图片下载功能优化

### 功能更新
1. 优化了爬虫的图片下载逻辑
2. 现在为每个爬取的文章创建单独的文件夹，文件夹名为公众号文章标题
3. 图片命名格式改为"公众号标题_序号.jpg"
4. 优化了CrawlerService的日志处理和异常处理

### 技术细节
- 修改了`WeChatArticleSpider.java`中的图片下载逻辑
- 图片现在保存在以文章标题命名的子文件夹中
- 处理了文件名中可能存在的非法字符
- 增强了爬虫服务的日志记录

### 后续优化方向
- 考虑添加图片去重功能
- 考虑添加图片压缩功能
- 改进文章标题提取以获得更准确的文件夹命名

## 4月22日更新 - 添加文章头图爬取功能

### 功能更新
1. 增加了爬取微信公众号文章头图的功能
2. 头图以"公众号标题_head.jpg"格式命名并保存
3. 在控制台输出头图链接，方便调试和跟踪
4. 将头图URL添加到数据库存储中

### 技术细节
- 新增`extractHeadImage`方法，从多个来源提取头图URL：
  - 首选从meta标签`og:image`获取
  - 尝试其他常见的头图相关meta标签
  - 如无法找到meta标签，则使用文章中第一张图片作为头图
- 优化了图片下载逻辑，支持头图下载
- 在数据库管道中添加头图处理逻辑
- 完善了错误处理和日志输出

### 后续优化方向
- 增加头图处理（如缩放、压缩）功能
- 优化头图提取的准确性和速度
- 提供头图预览功能

## 4月23日更新 - 前端显示文章头图功能

### 功能更新
1. 添加了在文章列表瀑布流中显示头图的功能
2. 实现了在文章详情页中显示大图版头图
3. 添加了后端API接口用于提供头图访问服务
4. 优化了用户体验，使界面更加美观和信息丰富

### 技术细节
- 新增后端接口`/api/crawler/image/{articleId}`用于获取文章头图URL
- 新增后端接口`/api/crawler/images/{folder}/{filename:.+}`用于直接提供图片文件访问
- 前端实现文章头图动态加载和显示
- 添加了加载失败时的静默处理，确保即使头图不存在也不会影响界面
- 优化了头图样式，添加了悬停效果和合适的尺寸约束

### 后续优化方向
- 考虑实现头图的懒加载，提高页面加载性能
- 添加图片缺失时的默认占位图
- 优化图片加载速度，可考虑添加图片缓存机制

## 4月24日更新 - 标签化推荐文章功能

### 功能更新
1. 实现了基于内容的文章标签提取功能
2. 添加了标签筛选文章功能
3. 在文章列表页面提供了标签选择界面
4. 在文章详情页中显示文章标签

### 技术细节
- 创建了`TagService`服务类，负责提取和管理文章标签
- 添加了预定义的标签分类（科技、AI、金融等）
- 基于内容关键词匹配实现了简单的标签提取算法
- 新增后端接口`/api/tags`用于获取所有可用标签
- 新增后端接口`/api/tags/article/{id}`用于获取特定文章的标签
- 新增后端接口`/api/tags/filter`用于根据标签筛选文章
- 前端实现了标签选择和筛选功能，通过点击标签可快速筛选相关文章

### 后续优化方向
- 实现更复杂的基于TF-IDF的标签提取算法
- 添加用户自定义标签功能
- 实现标签权重排序，提高推荐准确性
- 基于标签实现相似文章推荐功能
- 添加标签云组件，直观展示热门标签

## 4月25日更新 - 搜索功能修复与性能优化

### 功能更新
1. 修复了标签功能导致的搜索索引问题
2. 添加了重建索引API
3. 在前端添加了重建索引按钮
4. 优化了爬虫保存文章后的索引更新逻辑

### 技术细节
- 修改了`DatabasePipeline`类，确保新爬取的文章同时更新两个搜索索引
- 添加了`/api/search/rebuild-index`接口，支持手动重建所有文章的索引
- 在前端搜索表单旁添加了重建索引按钮，方便用户操作
- 完善了日志记录，便于追踪索引更新过程
- 通过两种索引服务的协同工作，确保搜索功能稳定性

### TF-IDF降序排序实现
- 使用Lucene的`SortField`和`Sort`实现搜索结果排序
- 在`ArticleSearchService`中添加了排序代码：
  ```java
  Sort sort = new Sort(new SortField("publishTime", SortField.Type.STRING, true));
  TopDocs topDocs = searcher.search(query, 100, sort);
  ```
- 当前排序是基于发布时间的降序，未来可以扩展为TF-IDF值排序

### 后续优化方向
- 完善TF-IDF计算逻辑，存储为独立字段用于排序
- 优化索引更新性能，考虑异步更新机制
- 添加索引状态监控功能
- 实现更复杂的搜索功能，如关键词高亮、相关度排序等
- 考虑分词优化，提高中文搜索准确性

## 2025-04-22: 修复搜索功能无响应问题

### 问题描述
前端搜索功能发送请求后，后端成功返回数据（日志显示"搜索结果数量: 2"），但页面未渲染搜索结果。用户在搜索框中输入关键词并点击搜索后，页面没有任何变化。

### 问题定位过程
1. **网络请求验证**：
   - 使用浏览器开发者工具检查网络请求
   - 确认请求URL: `http://localhost:5173/api/search?keyword=ai`
   - 请求状态码: 200 OK
   - 响应正确包含搜索结果数据

2. **后端日志分析**：
   ```
   2025-04-22T10:27:40.263+08:00  INFO 21232 --- [web2_7] [nio-8081-exec-8] o.e.w.c.ArticleSearchController          : 搜索文章，关键词: ai
   2025-04-22T10:27:40.267+08:00  INFO 21232 --- [web2_7] [nio-8081-exec-8] o.e.w.c.ArticleSearchController          : 搜索结果数量: 2
   ```
   确认后端正确处理了搜索请求并找到2条匹配结果

3. **前端代码审查**：
   - 检查 `Home.vue` 中的搜索函数实现
   - 发现在 `searchArticles` 函数中，搜索结果只更新到了 `articles` 数组，但未更新到页面实际渲染使用的 `filteredArticles` 数组
   ```javascript
   const searchArticles = async () => {
     try {
       // ...省略部分代码
       const response = await axios.get(`/api/search?keyword=${encodeURIComponent(searchKeyword.value.trim())}`);
       articles.value = response.data;
       // 这里缺少对 filteredArticles 的更新
       // ...省略部分代码
     } catch (error) {
       // ...省略错误处理代码
     }
   }
   ```

4. **问题根源**：
   经过分析代码结构，发现页面使用的是两层数据模型：
   - `articles`: 存储所有文章数据
   - `filteredArticles`: 用于实际页面渲染，支持标签筛选功能
   
   在搜索时只更新了`articles`而未同步更新`filteredArticles`，导致页面显示的内容没有变化

### 解决方案
在`searchArticles`函数中添加对`filteredArticles`的更新：
```javascript
const searchArticles = async () => {
  try {
    if (!searchKeyword.value.trim()) {
      await loadArticles();
      return;
    }
    const response = await axios.get(`/api/search?keyword=${encodeURIComponent(searchKeyword.value.trim())}`);
    console.log('搜索结果响应:', response);
    console.log('搜索结果数据:', response.data);
    articles.value = response.data;
    filteredArticles.value = response.data; // 添加此行，确保搜索结果也更新到filteredArticles
    if (articles.value.length === 0) {
      ElMessage.info('未找到匹配的文章');
    } else {
      console.log(`找到${articles.value.length}条搜索结果`);
    }
  } catch (error) {
    console.error('搜索失败:', error);
    ElMessage.error('搜索失败：' + (error.response?.data || error.message));
  }
}
```

### 修复效果
1. 搜索关键词时，结果现在同时更新到两个数组
2. 页面能正确显示搜索结果
3. 添加了额外调试日志以便于确认数据流向

### 经验总结
1. **数据流向一致性**：在Vue等响应式框架中，当有多个相关联的响应式数据源时，需确保所有用于渲染的数据都被正确更新
2. **调试日志的重要性**：添加关键点的日志输出有助于快速定位问题
3. **前后端联合调试**：结合后端日志和前端网络请求分析，能够更全面地了解数据流向

### 后续优化建议
1. 考虑重构数据模型，使用单一数据源或明确的数据流向
2. 为搜索功能添加加载状态指示
3. 考虑添加单元测试，防止类似问题再次出现