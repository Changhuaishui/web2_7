import{e as v,A as U,m as g,f as _,g as k,q as n,t as m,v as A,F as P,D as T,j as $,B as N,r as I,c as J,o as Q,E as r,G as W,H as X}from"./element-plus-Dc3FmvU_.js";import{_ as Z,b as ee,a as C}from"./index-DSQmJqxL.js";import"./zh-cn-iywqHVK7.js";const j={processArticleContent(l){if(!l||!l.content)return console.warn("文章内容为空"),"";const e=l.content.match(/\[\[IMG:([^\]]+)\]\]/g)||[];if((!l.imageMappings||l.imageMappings==="{}")&&e.length>0)return console.log(`没有图片映射信息，但发现 ${e.length} 个占位符，尝试自动修复`),this.autoFixPlaceholders(l,e);if(!l.imageMappings)return console.log("没有图片映射信息，返回原始内容"),l.content;try{const p=JSON.parse(l.imageMappings);let s=l.content;console.log(`处理文章内容，发现 ${Object.keys(p).length} 张图片需要替换`);const x=s.match(/\[\[IMG:[^\]]+\]\]/g)||[];console.log("找到的占位符:",x);for(const d in p){if(!d)continue;const f=p[d],i=`[[IMG:${d}]]`;console.log(`处理图片 ${d}, 占位符: ${i}, 图片数据:`,f);let u;if(l.ulid){const M=f.extension||".jpg";u=`/api/images/${l.ulid}/${d}${M}`,console.log(`为图片 ${d} 生成规范化路径(扩展名${M}): ${u}`)}else{const M=f.index;u=(l.images?l.images.split(","):[])[M]||"",u&&!u.startsWith("/api/")&&(u=`/api/images/${u}`),console.log(`为图片 ${d} 使用旧格式路径: ${u}`)}const c=`<img src="${u}" class="article-image" alt="文章图片${Number(f.index)+1}" style="max-width:100%; height:auto;" />`;if(s.includes(i))s=s.replace(i,c),console.log(`替换占位符 ${i} 成功`);else{console.warn(`未找到占位符 ${i}`);const M=`[[IMG:${d}]]`.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),R=new RegExp(M,"g");R.test(s)&&(s=s.replace(R,c),console.log("使用正则表达式替换占位符成功"))}}const h=s.match(/\[\[IMG:[^\]]+\]\]/g)||[];return h.length>0&&console.warn(`处理后仍有 ${h.length} 个未替换的占位符:`,h),s}catch(p){return console.error("处理文章内容出错:",p),l.content}},autoFixPlaceholders(l,e){if(!e||!l)return l.content;if(l.imageMappings&&Object.keys(JSON.parse(l.imageMappings)).length>0)return console.log("文章已有imageMappings数据，跳过自动修复",l.imageMappings),l.content;console.log("开始自动修复占位符，文章ID:",l.id);const p=/\[\[IMG:([^\]]+)\]\]/g;let s,x=0,h=l.content;for(;(s=p.exec(l.content))!==null;){const d=s[0],f=s[1];console.log(`找到占位符 ${d}，图片ID: ${f}`);let i;l.ulid?(i=`/api/images/${l.ulid}/${f}`,console.log(`为图片 ${f} 生成规范化路径(自动修复): ${i}`)):(i=(l.images?l.images.split(","):[])[x]||"",i&&!i.startsWith("/api/")&&(i=`/api/images/${i}`),console.log(`为图片 ${f} 使用旧格式路径: ${i}`));const u=`<div class="article-image-container"><img src="${i}" alt="文章图片 ${x+1}" style="max-width:100%; height:auto;" /></div>`;h=h.replace(d,u),x++}return console.log(`自动修复完成，共处理了 ${x} 个占位符`),h}};W.locale("zh-cn");const ae={name:"ArticleDetail",setup(){const l=ee(),e=I(null),p=I(null),s=I(!0),x=I([]),h=I(!1),d=I(""),f=I([]),i=I(!1),u=I(!1),c=I(!1),M=J(()=>{var t;return(t=e.value)!=null&&t.keywords?e.value.keywords.split(",").map(a=>a.trim()).filter(a=>a):[]}),R=t=>{if(!t)return console.log("时间为空:",t),"暂无时间";try{const a=W(t).format("YYYY-MM-DD HH:mm:ss");return console.log("格式化时间:",t,"->",a),a}catch(a){return console.error("时间格式化错误:",a,t),t}},z=async()=>{var t,a,o,w,G,H;try{console.log("请求文章详情，URL参数：",l.params.id);const y=await C.post("/api/crawler/articles/detail",{url:l.params.id});if(y.data){e.value={...y.data,author:y.data.author||"未知",accountName:y.data.accountName||"未知",publishTime:y.data.publishTime||null,summary:y.data.summary||null,keywords:y.data.keywords||null},console.log("文章数据:",e.value),e.value.keywords?(console.log("文章关键词:",e.value.keywords),console.log("关键词数组:",e.value.keywords.split(","))):console.warn("文章没有关键词"),console.log("图片映射信息(imageMappings):",e.value.imageMappings);const b=e.value.content.match(/\[\[IMG:[^\]]+\]\]/g)||[];if(console.log(`内容中包含 ${b.length} 个图片占位符`),e.value.imageMappings){console.log("找到图片映射信息，开始处理图文内容");try{const D=JSON.parse(e.value.imageMappings);console.log("解析后的映射信息:",D);const Y=(e.value.content.match(/\[\[IMG:[^\]]+\]\]/g)||[]).length;console.log(`文章内容中找到 ${Y} 个图片占位符`),d.value=j.processArticleContent(e.value)}catch(D){console.error("处理图文内容时出错:",D),d.value=e.value.content}}else b.length>0?(console.log("没有图片映射信息，但发现占位符，尝试自动修复"),d.value=j.autoFixPlaceholders(e.value,b)):(console.log("没有图片映射信息，使用原始内容"),d.value=e.value.content);await K(),await q(),e.value.id&&await L(e.value.id)}}catch(y){console.error("加载文章失败:",y),console.error("请求URL:",(t=y.config)==null?void 0:t.url),console.error("请求方法:",(a=y.config)==null?void 0:a.method),console.error("支持的方法:",(w=(o=y.response)==null?void 0:o.headers)==null?void 0:w.allow),console.error("错误详情:",((G=y.response)==null?void 0:G.data)||y.message),r.error("加载文章失败："+(((H=y.response)==null?void 0:H.data)||y.message))}finally{s.value=!1}},K=async()=>{if(!(!e.value||!e.value.id))try{if(!e.value.ulid){console.warn("文章没有ULID，尝试使用旧API获取头图");try{const o=await C.get(`/api/crawler/image/${e.value.id}`);if(o.data&&o.data.imageUrl){p.value=o.data.imageUrl,console.log("使用旧API获取头图成功:",p.value);return}}catch(o){console.warn("使用旧API获取头图失败:",o)}}if(!e.value.images){console.warn("文章没有图片信息");return}const t=e.value.images.split(",");if(t.length===0){console.warn("文章没有图片路径");return}const a=t[0];if(a.includes("/")){const o=`/api/images/${a}`;console.log("使用新API路径获取头图:",o),p.value=o}else console.log("使用旧格式图片路径:",a),a&&!a.startsWith("/api/")?(p.value=`/api/crawler/images/${a}`,console.log("使用旧格式图片路径(修正API前缀):",p.value)):p.value=a}catch(t){console.warn("无法加载文章头图:",t)}},q=async()=>{if(!(!e.value||!e.value.id))try{const t=await C.get(`/api/tags/article/${e.value.id}`);t.data&&t.data.tags&&(x.value=t.data.tags)}catch(t){console.warn("无法加载文章标签:",t)}},L=async t=>{try{const a=await C.get(`/api/articles/${t}/related`);a.data&&a.data.success&&(f.value=a.data.relatedArticles||[],console.log(`加载了${f.value.length}篇相关文章`))}catch(a){console.warn("无法加载相关文章:",a)}},B=async()=>{var t,a;if(!e.value||!e.value.id){r.warning("无法获取相关文章：缺少文章ID");return}i.value=!0;try{const o=await C.post(`/api/articles/${e.value.id}/crawl-related`);if(o.data&&o.data.success){const w=o.data.count||0;w>0?(r.success(`成功找到${w}篇相关文章`),await L(e.value.id)):r.info("未找到相关文章")}else r.error("获取相关文章失败："+(o.data.message||"未知错误"))}catch(o){console.error("获取相关文章失败:",o),r.error("获取相关文章失败："+(((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)||o.message))}finally{i.value=!1}},E=()=>{if(!e.value){r.warning("无效的文章数据");return}let t=e.value.sourceUrl;if((!t||t==="javascript:;")&&(t=e.value.url),!t||t==="javascript:;"||t.trim()===""){r.warning("无法获取有效的文章链接");return}console.log("打开链接:",t);try{new URL(t),window.open(t,"_blank")}catch(a){console.error("无效的URL格式:",t,a),r.error("无效的文章链接格式")}},F=async()=>{var t,a;if(!e.value||!e.value.id){r.warning("无法生成摘要：缺少文章ID");return}h.value=!0;try{const o=await C.post(`/api/articles/${e.value.id}/summarize`);o.data.success?(e.value.summary=o.data.summary,o.data.keywords&&(e.value.keywords=o.data.keywords),o.data.isExisting?r.info("已加载现有摘要"):(r.success("摘要生成成功"),o.data.relatedArticlesCount>0&&await L(e.value.id))):r.error("摘要生成失败："+o.data.message)}catch(o){console.error("生成摘要失败:",o),r.error("生成摘要失败："+(((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)||o.message))}finally{h.value=!1}},O=async()=>{var t,a;if(!e.value||!e.value.id){r.warning("无法重新生成摘要和关键词：缺少文章ID");return}c.value=!0;try{const o=await C.post(`/api/articles/${e.value.id}/summarize?force=true`);o.data.success?(e.value.summary=o.data.summary,o.data.keywords&&(e.value.keywords=o.data.keywords),r.success("摘要和关键词重新生成成功"),o.data.relatedArticlesCount>0&&(await L(e.value.id),r.info(`已找到${o.data.relatedArticlesCount}篇相关文章`))):r.error("重新生成失败："+o.data.message)}catch(o){console.error("重新生成摘要和关键词失败:",o),r.error("重新生成失败："+(((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)||o.message))}finally{c.value=!1}},S=async()=>{var t,a;if(!e.value||!e.value.id){r.warning("无法生成关键词：缺少文章ID");return}u.value=!0;try{const o=await C.post(`/api/articles/${e.value.id}/generate-keywords`);o.data.success?(e.value.keywords=o.data.keywords,r.success("关键词生成成功"),o.data.relatedArticlesCount>0&&(await L(e.value.id),r.info(`已找到${o.data.relatedArticlesCount}篇相关文章`))):r.error("关键词生成失败："+o.data.message)}catch(o){console.error("生成关键词失败:",o),r.error("生成关键词失败："+(((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)||o.message))}finally{u.value=!1}},V=t=>{if(!t){r.warning("文章链接不可用"),console.error("文章链接为空");return}console.log("打开相关文章链接:",t);try{let a=t;if(a.includes("&amp;")&&(a=a.replace(/&amp;/g,"&"),console.log("修复HTML实体编码:",a)),a.startsWith("/link?url=")&&(a="https://weixin.sogou.com"+a,console.log("添加域名到相对URL:",a)),a.includes("weixin.sogou.com/link?url=")){console.log("检测到搜狗链接，直接跳转:",a),window.open(a,"_blank");return}if(a.includes("url="))try{const o=a.match(/url=([^&]+)/);if(o&&o[1]){let w=decodeURIComponent(o[1]);console.log("从搜狗链接提取目标URL:",w),!w.startsWith("http")&&(w.includes("mp.weixin.qq.com")||w.includes("weixin.qq.com"))&&(w="https://"+w,console.log("添加https前缀到微信URL:",w)),a=w}}catch(o){console.warn("提取搜狗链接参数失败:",o)}!a.startsWith("http://")&&!a.startsWith("https://")&&(a="https://"+a,console.log("添加协议到URL:",a)),new URL(a),a.includes("weixin.sogou.com")&&r({message:"正在跳转到搜狗中转页面，可能需要验证",type:"warning",duration:3e3}),console.log("最终跳转URL:",a),window.open(a,"_blank")}catch(a){if(console.error("无效的URL格式:",t,a),t.includes("weixin.sogou.com")||t.includes("sogou")){console.log("尝试直接打开搜狗URL:",t),r({message:"链接格式异常，尝试直接跳转到搜狗页面",type:"warning",duration:3e3}),window.open("https://weixin.sogou.com","_blank");return}r.error("无效的文章链接格式")}};return Q(()=>{z()}),{article:e,openArticle:E,formatDate:R,headImage:p,loading:s,articleTags:x,generateSummary:F,generateSummaryLoading:h,processedContent:d,relatedArticles:f,loadingRelated:i,fetchRelatedArticles:B,keywordsList:M,generateKeywords:S,generatingKeywords:u,regenerateSummaryAndKeywords:O,regeneratingAll:c,openRelatedArticle:V}}},oe={key:0,class:"article-detail"},te={class:"article-header"},se={class:"article-meta"},le={key:0},ne={key:1},re={key:0,class:"article-tags"},ie={key:0,class:"article-head-image"},ce=["src"],de={key:1,class:"article-summary"},ge={class:"summary-content"},ue={key:0,class:"keywords-in-summary"},me={key:1,class:"keywords-in-summary"},pe={class:"regenerate-buttons",style:{"margin-top":"15px"}},fe={key:2,class:"article-summary-generate"},ye=["innerHTML"],ve={key:3,class:"related-articles"},we={class:"related-article-list"},he=["href","onClick"],ke={key:0,class:"article-link-debug",style:{display:"none"}},Ae={class:"article-footer"};function xe(l,e,p,s,x,h){const d=$("el-tooltip"),f=$("el-tag"),i=$("el-button"),u=$("el-card");return s.article?(g(),v("div",oe,[_(u,null,{header:k(()=>[m("div",te,[m("h1",null,A(s.article.title),1),e[5]||(e[5]=n()),m("div",se,[m("span",null,"作者："+A(s.article.author||"未知"),1),e[3]||(e[3]=n()),m("span",null,"公众号："+A(s.article.accountName||"未知"),1),e[4]||(e[4]=n()),m("span",null,[e[2]||(e[2]=n(`发布时间：
              `)),s.article.publishTime?(g(),v("span",le,[n(A(s.formatDate(s.article.publishTime))+" ",1),_(d,{effect:"dark",placement:"top"},{content:k(()=>[n(`
                    原始值: `+A(s.article.publishTime),1)]),default:k(()=>[e[0]||(e[0]=n()),e[1]||(e[1]=m("i",{class:"el-icon-info",style:{"margin-left":"5px"}},null,-1))]),_:1})])):(g(),v("span",ne,"暂无时间"))])]),e[6]||(e[6]=n()),s.articleTags.length?(g(),v("div",re,[(g(!0),v(P,null,T(s.articleTags,c=>(g(),N(f,{key:c,type:"primary",effect:"light",class:"tag-item"},{default:k(()=>[n(A(c),1)]),_:2},1024))),128))])):U("",!0)])]),default:k(()=>[e[20]||(e[20]=n()),s.headImage?(g(),v("div",ie,[m("img",{src:s.headImage,alt:"文章头图"},null,8,ce)])):U("",!0),e[21]||(e[21]=n()),s.article.summary?(g(),v("div",de,[e[11]||(e[11]=m("h3",null,"文章摘要",-1)),e[12]||(e[12]=n()),m("div",ge,A(s.article.summary),1),e[13]||(e[13]=n()),s.article.keywords?(g(),v("div",ue,[e[7]||(e[7]=m("span",{class:"keywords-label"},"关键词：",-1)),e[8]||(e[8]=n()),(g(!0),v(P,null,T(s.keywordsList,c=>(g(),N(f,{key:c,type:"primary",effect:"light",class:"keyword-item",size:"small"},{default:k(()=>[n(A(c),1)]),_:2},1024))),128))])):(g(),v("div",me,[_(i,{type:"primary",onClick:s.generateKeywords,loading:s.generatingKeywords,size:"small",plain:""},{default:k(()=>e[9]||(e[9]=[n(`
            生成文章关键词
          `)])),_:1},8,["onClick","loading"])])),e[14]||(e[14]=n()),m("div",pe,[_(i,{type:"primary",onClick:s.regenerateSummaryAndKeywords,loading:s.regeneratingAll,size:"small",plain:""},{default:k(()=>e[10]||(e[10]=[n(`
            重新生成摘要和关键词
          `)])),_:1},8,["onClick","loading"])])])):(g(),v("div",fe,[_(i,{type:"primary",onClick:s.generateSummary,loading:s.generateSummaryLoading,plain:""},{default:k(()=>e[15]||(e[15]=[n(`
          生成文章摘要
        `)])),_:1},8,["onClick","loading"])])),e[22]||(e[22]=n()),m("div",{class:"article-content",innerHTML:s.processedContent},null,8,ye),e[23]||(e[23]=n()),e[24]||(e[24]=n()),s.relatedArticles.length?(g(),v("div",ve,[e[16]||(e[16]=m("h3",null,"相关文章",-1)),e[17]||(e[17]=n()),m("ul",we,[(g(!0),v(P,null,T(s.relatedArticles,c=>(g(),v("li",{key:c.id,class:"related-article-item"},[m("a",{href:c.relatedUrl,target:"_blank",class:"related-article-link",onClick:X(M=>s.openRelatedArticle(c.relatedUrl),["prevent"])},[n(A(c.title||"相关文章")+" ",1),c.relatedUrl?(g(),v("span",ke,A(c.relatedUrl),1)):U("",!0)],8,he)]))),128))])])):U("",!0),e[25]||(e[25]=n()),m("div",Ae,[_(i,{type:"primary",onClick:s.openArticle},{default:k(()=>[n(A(s.article.sourceUrl?"阅读原文":"查看文章"),1)]),_:1},8,["onClick"]),e[19]||(e[19]=n()),s.relatedArticles.length?U("",!0):(g(),N(i,{key:0,type:"info",onClick:s.fetchRelatedArticles,loading:s.loadingRelated},{default:k(()=>e[18]||(e[18]=[n(`
          查找相关文章
        `)])),_:1},8,["onClick","loading"]))])]),_:1})])):U("",!0)}const Ue=Z(ae,[["render",xe],["__scopeId","data-v-17865e5a"]]);export{Ue as default};
//# sourceMappingURL=ArticleDetail-CU5SxC5i.js.map
