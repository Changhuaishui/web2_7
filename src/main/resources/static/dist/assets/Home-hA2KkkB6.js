import{e as x,m as k,A as h,q as n,f as c,B as $,g as i,j as v,t as d,C as W,F as j,D as F,r as f,o as q,E as a,G as K,k as G,l as J,v as b}from"./element-plus-Dc3FmvU_.js";import{_ as O,a as g,u as Q}from"./index-DSQmJqxL.js";import"./zh-cn-iywqHVK7.js";K.locale("zh-cn");const X={name:"Home",setup(){const w=f({url:""}),r=f(!1),R=f(""),s=f([]);Q();const y=f({}),I=f([]),A=f("全部"),p=f([]),m=f(!1),L=async()=>{var e;if(!w.value.url){a.warning("请输入文章URL");return}r.value=!0;try{const o=await g.post("/api/crawler/check-link",{url:w.value.url});if(o.data.status==="already_exists"){a.info("该文章已经爬取过，无需重复爬取"),w.value.url="",await U();return}if(o.data.status==="invalid"){a.error("链接无效或已失效，无法爬取，可能是临时链接已过期");return}const t=await g.post("/api/crawler/crawl",{url:w.value.url});a.success(t.data),w.value.url="",U()}catch(o){console.error("爬取失败:",o),(e=o.response)!=null&&e.data?a.error(o.response.data):a.error("爬取失败："+o.message)}finally{r.value=!1}},_=async()=>{var e;try{if(!R.value.trim()){await U();return}const o=await g.get(`/api/search?keyword=${encodeURIComponent(R.value.trim())}`);console.log("搜索结果响应:",o),console.log("搜索结果数据:",o.data),s.value=o.data,p.value=o.data,s.value.length===0?a.info("未找到匹配的文章"):console.log(`找到${s.value.length}条搜索结果`)}catch(o){console.error("搜索失败:",o),a.error("搜索失败："+(((e=o.response)==null?void 0:e.data)||o.message))}},U=async()=>{try{const e=await g.get("/api/crawler/articles");console.log("API返回的完整数据:",e),console.log("文章数据:",e.data),e.data&&e.data.length>0&&console.log("第一篇文章的时间:",e.data[0].publishTime),s.value=e.data,p.value=e.data;for(const o of s.value)T(o.id)}catch(e){console.error("加载文章失败:",e),a.error("加载文章失败")}},T=async e=>{if(e)try{const o=s.value.find(t=>t.id===e);if(!o){console.warn(`未找到ID为${e}的文章`);return}if(!o.ulid){console.warn(`文章ID=${e}没有ULID，尝试使用旧API获取头图`);try{const t=await g.get(`/api/crawler/image/${e}`);if(t.data&&t.data.imageUrl){y.value[e]=t.data.imageUrl,console.log(`文章${e}使用旧API获取头图成功:`,t.data.imageUrl);return}}catch(t){console.warn(`文章${e}使用旧API获取头图失败:`,t)}}if(o.images&&o.images.trim()){const t=o.images.split(",");if(t.length>0){const u=t[0];if(u.includes("/")){const C=`/api/images/${u}`;console.log(`文章${e}使用新API路径获取头图: ${C}`),y.value[e]=C}else console.log(`文章${e}使用旧API路径获取头图: ${u}`),u&&!u.startsWith("/api/")?(y.value[e]=`/api/crawler/images/${u}`,console.log(`文章${e}使用旧格式图片路径(修正API前缀):`,y.value[e])):y.value[e]=u}}else console.warn(`文章ID=${e}没有图片`)}catch(o){console.warn(`无法加载文章${e}的头图:`,o)}},B=async()=>{try{const e=await g.get("/api/tags");I.value=["全部",...e.data]}catch(e){console.error("加载标签失败:",e),a.error("加载标签失败")}},l=async e=>{A.value=e;try{if(e==="全部")p.value=s.value;else{const o=await g.get(`/api/tags/filter?tag=${encodeURIComponent(e)}`);p.value=o.data}}catch(o){console.error("根据标签筛选文章失败:",o),a.error("筛选文章失败")}},D=e=>{if(!e)return console.log("时间为空:",e),"暂无时间";try{const o=K(e).format("YYYY-MM-DD HH:mm:ss");return console.log("格式化时间:",e,"->",o),o}catch(o){return console.error("时间格式化错误:",o,e),e}},E=e=>{if(!e){a.warning("无效的文章数据");return}console.log("文章数据:",e),console.log("原文链接:",e.sourceUrl),console.log("文章链接:",e.url);let o=e.sourceUrl;if((!o||o==="javascript:;"||o==="javascript:void(0);"||o.trim()==="")&&(console.log("原文链接无效，使用文章URL"),o=e.url),!o||o==="javascript:;"||o==="javascript:void(0);"||o.trim()===""){console.log("无效的URL:",o),a.warning("无法获取有效的文章链接");return}!o.startsWith("http://")&&!o.startsWith("https://")&&(o="https://"+o),console.log("最终使用的链接:",o);try{new URL(o),window.open(o,"_blank")}catch(t){console.error("无效的URL格式:",o,t),a.error("无效的文章链接格式")}},M=async e=>{var o;try{if(!e||!e.url){a.error("无效的文章数据");return}if(await G.confirm(`确定要删除文章"${e.title}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})!=="confirm")return;const C=e.url.split(",")[0]||"";if(!C){a.error("无效的URL");return}const z=encodeURIComponent(encodeURIComponent(C)),H=J.service({lock:!0,text:"正在删除文章...",background:"rgba(0, 0, 0, 0.7)"});try{const V=await g.delete(`/api/crawler/articles/${z}`);if(V.status===200){a.success("删除成功");const P=s.value.findIndex(Y=>Y.url===e.url);P!==-1&&s.value.splice(P,1)}else a.warning(V.data||"删除可能未完成，请刷新页面确认")}finally{H.close()}}catch(t){if(console.error("删除失败:",t),(o=t.response)!=null&&o.data){const u=t.response.data.includes("<!doctype html>")?"服务器请求错误":t.response.data;a.error(`删除失败：${u}`)}else t.request?a.error("删除失败：无法连接到服务器"):a.error(`删除失败：${t.message}`)}},N=async()=>{var e,o;try{m.value=!0,a.info("正在重建搜索索引，请稍候...");const t=await g.post("/api/search/rebuild-index");t.data&&t.data.success?a.success(t.data.message||"搜索索引重建成功"):a.warning("重建过程完成，但可能存在问题")}catch(t){console.error("重建索引失败:",t),a.error("重建搜索索引失败: "+(((o=(e=t.response)==null?void 0:e.data)==null?void 0:o.error)||t.message))}finally{m.value=!1}};return q(()=>{U(),B()}),{crawlerForm:w,crawling:r,searchKeyword:R,articles:s,articleImages:y,tags:I,selectedTag:A,filteredArticles:p,rebuildingIndex:m,crawlArticle:L,searchArticles:_,deleteArticle:M,formatDate:D,openArticle:E,filterByTag:l,rebuildSearchIndex:N}}},Z={class:"home"},S={class:"card-header"},ee={class:"card-header"},oe={class:"tag-container"},re={class:"waterfall-container"},se={key:0,class:"article-image"},te=["src"],ae={class:"article-title"},ne={class:"article-meta"},le={class:"author"},ie={class:"account"},ce={class:"time"},de={class:"article-actions"};function ue(w,r,R,s,y,I){const A=v("el-input"),p=v("el-form-item"),m=v("el-button"),L=v("el-form"),_=v("el-card"),U=v("el-tag"),T=v("router-link"),B=v("el-button-group");return k(),x("div",Z,[h(" 爬虫表单 "),r[22]||(r[22]=n()),c(_,{class:"crawler-form"},{header:i(()=>r[2]||(r[2]=[d("div",{class:"card-header"},[d("span",null,"添加文章")],-1)])),default:i(()=>[r[5]||(r[5]=n()),c(L,{model:s.crawlerForm,"label-width":"120px"},{default:i(()=>[c(p,{label:"文章URL"},{default:i(()=>[c(A,{modelValue:s.crawlerForm.url,"onUpdate:modelValue":r[0]||(r[0]=l=>s.crawlerForm.url=l),placeholder:"请输入微信公众号文章URL"},null,8,["modelValue"])]),_:1}),r[4]||(r[4]=n()),c(p,null,{default:i(()=>[c(m,{type:"primary",onClick:s.crawlArticle,loading:s.crawling},{default:i(()=>r[3]||(r[3]=[n(`
            开始爬取
          `)])),_:1},8,["onClick","loading"])]),_:1})]),_:1},8,["model"])]),_:1}),r[23]||(r[23]=n()),h(" 搜索框 "),r[24]||(r[24]=n()),c(_,{class:"search-form"},{header:i(()=>[d("div",S,[r[7]||(r[7]=d("span",null,"搜索文章",-1)),r[8]||(r[8]=n()),c(m,{type:"warning",size:"small",onClick:s.rebuildSearchIndex,loading:s.rebuildingIndex},{default:i(()=>r[6]||(r[6]=[n(`
            重建搜索索引
          `)])),_:1},8,["onClick","loading"])])]),default:i(()=>[r[10]||(r[10]=n()),c(A,{modelValue:s.searchKeyword,"onUpdate:modelValue":r[1]||(r[1]=l=>s.searchKeyword=l),placeholder:"请输入搜索关键词",class:"search-input",onKeyup:W(s.searchArticles,["enter"])},{append:i(()=>[c(m,{onClick:s.searchArticles},{default:i(()=>r[9]||(r[9]=[n("搜索")])),_:1},8,["onClick"])]),_:1},8,["modelValue","onKeyup"])]),_:1}),r[25]||(r[25]=n()),h(" 文章列表 "),r[26]||(r[26]=n()),s.articles.length>0?(k(),$(_,{key:0,class:"article-list"},{header:i(()=>[d("div",ee,[r[11]||(r[11]=d("span",null,"文章列表",-1)),r[12]||(r[12]=n()),d("div",oe,[(k(!0),x(j,null,F(s.tags,l=>(k(),$(U,{key:l,type:s.selectedTag===l?"primary":"info",effect:"plain",class:"tag-item",onClick:D=>s.filterByTag(l)},{default:i(()=>[n(b(l),1)]),_:2},1032,["type","onClick"]))),128))])])]),default:i(()=>[r[21]||(r[21]=n()),d("div",re,[(k(!0),x(j,null,F(s.filteredArticles,l=>(k(),x("div",{key:l.id,class:"article-card"},[c(_,{shadow:"hover",class:"article-item"},{default:i(()=>[s.articleImages[l.id]?(k(),x("div",se,[d("img",{src:s.articleImages[l.id],alt:"文章头图"},null,8,te)])):h("",!0),r[18]||(r[18]=n()),d("div",ae,[c(T,{to:{name:"ArticleDetail",params:{id:encodeURIComponent(l.url)}}},{default:i(()=>[n(b(l.title),1)]),_:2},1032,["to"])]),r[19]||(r[19]=n()),d("div",ne,[d("span",le,"作者："+b(l.author),1),r[13]||(r[13]=n()),d("span",ie,"公众号："+b(l.accountName),1),r[14]||(r[14]=n()),d("span",ce,"发布时间："+b(s.formatDate(l.publishTime)),1)]),r[20]||(r[20]=n()),d("div",de,[c(B,null,{default:i(()=>[c(m,{size:"small",type:"primary",onClick:D=>s.openArticle(l)},{default:i(()=>r[15]||(r[15]=[n(`
                  阅读原文
                `)])),_:2},1032,["onClick"]),r[17]||(r[17]=n()),c(m,{size:"small",type:"danger",onClick:D=>s.deleteArticle(l)},{default:i(()=>r[16]||(r[16]=[n(`
                  删除
                `)])),_:2},1032,["onClick"])]),_:2},1024)])]),_:2},1024)]))),128))])]),_:1})):h("",!0)])}const pe=O(X,[["render",ue],["__scopeId","data-v-dab25625"]]);export{pe as default};
//# sourceMappingURL=Home-hA2KkkB6.js.map
